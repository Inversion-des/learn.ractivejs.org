<link rel='ractive' href='./tutorial-header.html'>
<link rel='ractive' href='./left-nav.html'>
<link rel='ractive' href='./divvy.html'>
<link rel='ractive' href='./codemirror.html'>

<div class='app' style='{{style}}' on-tap='tapped'>
	<div class='content {{navOpen ? "obscured" : "" }}' on-tap='hideNav'>
		<tutorial-header step='{{currentStep}}'/>

		<divvy columns='[
			{ size: 45, children: [{ id: "copy-block", size: 3 }, { id: "output-block", size: 2 }] },
			{ size: 55, children: [{ id: "template", size: 3 }, { id: "javascript", size: 5 }] }
		]'>
			<!-- copy -->
			<div id='copy-block'>
				{{{currentStep.copy}}}
			</div>

			<!-- output -->
			<div id='output-block'></div>

			<!-- template -->
			<div id='template'>
				<codemirror mode='htmlmixed' value='{{template}}' height='100%'/>
			</div>

			<!-- js -->
			<div id='javascript'>
				<codemirror mode='javascript' value='{{javascript}}' height='100%'/>
			</div>
		</divvy>
	</div>

	<left-nav open='{{navOpen}}'/>
</div>

<style>
	.app {
		position: relative;
		padding: 5em 0.5em 0.5em 4.7em;

		-webkit-transition: all 0.2s cubic-bezier(.02,.91,.29,1);
		-moz-transition: all 0.2s cubic-bezier(.02,.91,.29,1);
		-ms-transition: all 0.2s cubic-bezier(.02,.91,.29,1);
		-o-transition: all 0.2s cubic-bezier(.02,.91,.29,1);
		transition: all 0.2s cubic-bezier(.02,.91,.29,1);

		-webkit-box-sizing: border-box;
		-moz-box-sizing: border-box;
		box-sizing: border-box;
	}

	.content {
		position: relative;
		width: 100%;
		height: 100%;

		-webkit-transition: all 0.2s cubic-bezier(.02,.91,.29,1);
		-moz-transition: all 0.2s cubic-bezier(.02,.91,.29,1);
		-ms-transition: all 0.2s cubic-bezier(.02,.91,.29,1);
		-o-transition: all 0.2s cubic-bezier(.02,.91,.29,1);
		transition: all 0.2s cubic-bezier(.02,.91,.29,1);
	}

	.content.obscured {
		opacity: 0.2;
	}

	.divvy-container {
		position: relative;
		width: 100%;
		height: 100%;
	}
</style>

<script>
	var forceRedraw = require( 'utils/forceRedraw' );

	component.exports = {
		init: function () {
			var self = this, container, divvy, baseUrl, pattern, redrawTimeout;

			container = this.find( '.app' );

			baseUrl = window.location.origin;
			pattern = /\/([^\/]+)\/(\d+)/;

			if ( window.history !== undefined && typeof window.history.pushState === 'function' ) {
				this.on({
					tapped: function ( event ) {
						var target = event.original.target, isLeftButton, href, match;

						if ( target === container ) {
							return;
						}

						// if it wasn't the left mouse button, or the
						// meta key was pressed, abort
						isLeftButton = ( event.original.which !== undefined && event.original.which !== 1 ) ||
										( event.original.button !== undefined && event.original.button === 0 );

						if ( event.original.metaKey || !isLeftButton ) {
							return;
						}

						// need to see if we're navigating to another tutorial,
						// and if so navigate without reloading the page
						do {
							if ( target.tagName === 'A' ) {
								href = target.href;

								if ( href.indexOf( baseUrl ) ) {
									continue;
								}

								href = href.substring( baseUrl.length );
								if ( match = pattern.exec( href ) ) {
									event.original.preventDefault();
									this.fire( 'navigate', match[1], match[2] );
									break;
								}
							}

							target = target.parentNode;
						} while ( target !== container );
					}
				});
			}

			this.on({
				hideNav: () => this.set( 'navOpen', false )
			});

			this.observe({
				currentStep: function ( step ) {

					// force a redraw... the use of transforms seems
					// to bork things up a bit
					forceRedraw();

					this.set({
						// whenever this changes, shut the nav
						navOpen: false,

						// clone step data
						template: step.template,
						javascript: step.javascript
					});

					// force a redraw... the use of transforms seems
					// to bork things up a bit
					//forceRedraw();
				},
				navOpen: function () {
					// ugh...
					clearTimeout( redrawTimeout );

					redrawTimeout = setTimeout( forceRedraw, 200 );
				}
			});
		},

		computed: {
			style: function () {
				var open = this.get( 'navOpen' );

				// TODO accommodate shit browsers...
				return [ '-webkit-', '-moz-', '-ms-', '-o-', '' ].map( prefix => {
					return prefix + 'transform: translate(' + ( open ? 12 : 0 ) + 'em,0)';
				}).join( ';' );
			}
		}
	};
</script>
